#!/bin/bash

macros=output/macros
pictures=pictures/macros
mkdir -p $macros $pictures

cat logs/freefem.log | grep "Iteration: "                  | awk '{ print $NF }' > $macros/iter.txt
cat logs/freefem.log | grep "Time: "                       | awk '{ print $NF }' > $macros/iter.txt
cat logs/freefem.log | grep "Mass: "                       | awk '{ print $NF }' > $macros/mass.txt
cat logs/freefem.log | grep "Diffusive mass flux: "        | awk '{ print $NF }' > $macros/diffMass.txt
cat logs/freefem.log | grep "Convective mass flux: "       | awk '{ print $NF }' > $macros/convMass.txt
cat logs/freefem.log | grep "Bulk free energy: "           | awk '{ print $NF }' > $macros/bulkFree.txt
cat logs/freefem.log | grep "Wall free energy: "           | awk '{ print $NF }' > $macros/wallFree.txt
cat logs/freefem.log | grep "Free energy dissipations: "   | awk '{ print $NF }' > $macros/dissFree.txt
cat logs/freefem.log | grep "Diffusive free energy flux: " | awk '{ print $NF }' > $macros/diffFree.txt
cat logs/freefem.log | grep "Increase in free energy: "    | awk '{ print $NF }' > $macros/incFree.txt
cat logs/freefem.log | grep "Free energy balance"          | awk '{ print $NF }' > $macros/freeBal.txt

ls $macros | while read f; do
gnuplot -p <<endOfScript
    set term pdf
    unset key
    set title "${f%.txt}"
    set output "$pictures/${f%.txt}.pdf"
    plot "<paste output/macros/iter.txt output/macros/${f}" w l
endOfScript

gnuplot -p <<endOfScript
    set term pdf
    unset key
    set title "All energies"
    set output "$pictures/energies.pdf
    plot "<paste output/macros/iter.txt output/macros/bulkFree.txt" w l, "<paste output/macros/iter.txt output/macros/wallFree.txt" w l, "<paste output/macros/iter.txt output/macros/dissFree.txt" w l, "<paste output/macros/iter.txt output/macros/diffFree.txt" w l
endOfScript

done
